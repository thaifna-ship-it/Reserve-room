<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>จองห้องประชุม</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

  <style>
    :root {
      --bg:#0b1220;--panel:#0f172a;--border:#223047;--fg:#e5e7eb;--muted:#94a3b8;
      --primary:#22c55e;--danger:#ef4444;--dayred:#fee2e2;
      --input-bg:#0b1220;--btn-ghost-bg:#0b1220; --shadow:0 6px 20px rgba(0,0,0,.25);
    }
    [data-theme="light"] {
      --bg:#f6f7fb;--panel:#fff;--border:#e5e7eb;--fg:#0f172a;--muted:#64748b;
      --primary:#16a34a;--danger:#dc2626;--dayred:#fee2e2;--input-bg:#fff;--btn-ghost-bg:#f8fafc;
      --shadow:0 6px 20px rgba(0,0,0,.06);
    }

    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:6px 0 12px;font-size:1.6rem}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .right-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{border:1px solid var(--border);background:var(--btn-ghost-bg);color:var(--fg);padding:6px 10px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow);transition:.2s}
    .chip.active{background:linear-gradient(90deg,#16a34a,#22c55e);color:#062d13;border:0}
    .panel{background:linear-gradient(180deg,var(--panel),var(--bg));border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
    #calendar{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px}
    .fc .fc-daygrid-day.fc-day-today{background:rgba(34,197,94,.12)}
    .legend{font-size:.9rem;color:var(--muted);margin:10px 0 0}
    .legend i{display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--dayred);margin-right:6px;border:1px solid #fca5a5}

    .modal-backdrop{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:560px;max-width:calc(100vw - 24px);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid .full{grid-column:1/-1}
    label{display:block;font-size:.88rem;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;border-radius:10px;border:1px solid var(--border);background:var(--input-bg);color:var(--fg);padding:10px}
    [data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] button{color:#0f172a}
    .row{display:flex;gap:10px;margin-top:12px}
    .btn{cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);color:#062d13;border:0}
    .btn.ghost{background:var(--btn-ghost-bg)}
    .msg{margin-top:8px;font-size:.9rem}
    .msg.err{color:#ef4444}
    .msg.ok{color:#16a34a}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="toolbar">
        <h1 id="titleText">ปฏิทินจองห้อง</h1>
        <div class="right-tools">
          <select id="filterRoom" class="chip" style="padding:8px 12px">
            <option value="">ทุกห้อง</option>
            <option>R1</option>
            <option>R2</option>
          </select>

          <div class="lang-switch">
            <button type="button" id="btnTH" class="chip active">TH</button>
            <button type="button" id="btnJP" class="chip">JP</button>
          </div>
          <div class="theme-switch">
            <button type="button" id="btnDark" class="chip active">Dark</button>
            <button type="button" id="btnLight" class="chip">Light</button>
          </div>
          <button type="button" id="btnPing" class="chip">Test API</button>
        </div>
      </div>

      <div id="calendar"></div>
      <div class="legend"><i></i> <span id="legendText">มีการจองในวันนั้น</span></div>

      <!-- ✅ กล่องแสดงรายการจองของวันนั้น -->
      <div id="dayBookings" class="panel" style="margin-top:12px; display:none">
        <h3 id="dayTitle" style="margin:6px 0 12px;font-size:1.1rem"></h3>
        <div id="dayList" style="display:grid; gap:8px"></div>
      </div>

    </div>
  </div>

  <!-- Modal ฟอร์มจอง -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3 id="bookingTitle">จองห้อง</h3>
      <form id="bookingForm" autocomplete="off">
        <div class="grid">
          <div class="full">
            <label id="labelCompany">Company</label>
            <select name="company" required>
              <option value="" disabled selected id="optChooseCompany">เลือกบริษัท</option>
              <option>NCNA &amp; NC BIZ</option>
              <option>S.I.Placement</option>
              <option>Alberryasia</option>
            </select>
          </div>
          <div>
            <label id="labelRequester">Requester</label>
            <input name="requester" required>
          </div>
          <div>
            <label id="labelDate">วันที่</label>
            <input type="date" name="date" required>
          </div>
          <div>
            <label id="labelStart">Start time</label>
            <select name="start" id="startSel" required></select>
          </div>
          <div>
            <label id="labelEnd">End time</label>
            <select name="end" id="endSel" required></select>
          </div>
          <div class="full">
            <label id="labelRoom">Room</label>
            <select name="room" required>
              <option value="" disabled selected id="optChooseRoom">เลือกห้อง</option>
              <option>R1</option>
              <option>R2</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button type="button" class="btn ghost" id="btnCancel">ยกเลิก</button>
          <button type="submit" class="btn primary" id="btnSubmit">จอง</button>
        </div>
        <div class="msg" id="formMsg"></div>
      </form>
    </div>
  </div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwqYgWnnPY1bp4L637w1HCdPXpdEARkTvI20iYkirionUm-HfbDj-2cUKFySdJz8SMNjQ/exec";
const $ = (s,el=document)=>el.querySelector(s);
let currentLang='th';
let calendar, latestRows=[], currentFilter='', selectedDate=null;

// === ฟังก์ชันแสดงรายการจองของวัน ===
function renderDayList(dateIso){
  const wrap = $('#dayBookings'), list = $('#dayList'), title = $('#dayTitle');
  if (!dateIso || !Array.isArray(latestRows)) { wrap.style.display='none'; return; }

  const rows = latestRows.filter(r => String(r.date) === String(dateIso))
                         .sort((a,b)=>a.start.localeCompare(b.start));
  title.textContent = `รายการจองวันที่ ${dateIso}`;

  if (!rows.length){
    list.innerHTML = `<div style="color:var(--muted)">ยังไม่มีการจองในวันนี้</div>`;
  } else {
    list.innerHTML = rows.map(r =>
      `<div style="border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--panel)">
        <strong>${r.start} - ${r.end}</strong> (${r.room})<br>
        <small>${r.company} - ${r.requester}</small>
      </div>`
    ).join('');
  }
  wrap.style.display='block';
}

const I18N={th:{title:'ปฏิทินจองห้อง',legend:'มีการจองในวันนั้น',modalTitle:'จองห้อง',
company:'Company',chooseCompany:'เลือกบริษัท',requester:'Requester',date:'วันที่',
start:'เวลาเริ่ม',end:'เวลาสิ้นสุด',room:'Room',chooseRoom:'เลือกห้อง',
cancel:'ยกเลิก',submit:'จอง',errorEnd:'เวลาสิ้นสุดต้องมากกว่าเวลาเริ่มต้น',
success:'จองสำเร็จ ✓',conflictNow:'ช่วงเวลานี้ถูกจองแล้ว',error:'ผิดพลาด: '}};

// ===== Theme / Language functions =====
function applyTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('room_theme',t);
$('#btnDark').classList.toggle('active',t==='dark');$('#btnLight').classList.toggle('active',t==='light');}
function applyLang(l){currentLang=l;const t=I18N[l];$('#titleText').textContent=t.title;$('#legendText').textContent=t.legend;
$('#bookingTitle').textContent=t.modalTitle;$('#labelCompany').textContent=t.company;$('#optChooseCompany').textContent=t.chooseCompany;
$('#labelRequester').textContent=t.requester;$('#labelDate').textContent=t.date;$('#labelStart').textContent=t.start;
$('#labelEnd').textContent=t.end;$('#labelRoom').textContent=t.room;$('#optChooseRoom').textContent=t.chooseRoom;
$('#btnCancel').textContent=t.cancel;$('#btnSubmit').textContent=t.submit;
$('#btnTH').classList.toggle('active',l==='th');$('#btnJP').classList.toggle('active',l==='ja');
if(calendar){calendar.setOption('locale',l==='ja'?'ja':'th');calendar.updateSize();}}
function openModal(){ $('#modalBackdrop').style.display='flex'; }
function closeModal(){ $('#modalBackdrop').style.display='none'; }

async function fetchBookings(){try{const r=await fetch(ENDPOINT+'?action=list&_='+Date.now());return r.ok?await r.json():[];}catch{return []}}
function toMinutes(t){const[a,b='0']=String(t).split(':');return(+a)*60+(+b)}
function fmtTime(t){const[h,m]=t.split(':');return h.padStart(2,'0')+':'+m.padStart(2,'0');}

function buildEv(rows){
  const events=rows.map(x=>({id:x.BookingID,title:`${fmtTime(x.start)}-${fmtTime(x.end)} (${x.room})`,
  start:`${x.date}T${x.start}`,end:`${x.date}T${x.end}`,color:'#ef4444'}));
  const days=[...new Set(rows.map(x=>x.date))];
  const bg=days.map(d=>({start:d,end:d,allDay:true,display:'background',backgroundColor:'#fee2e2'}));
  return events.concat(bg);
}

async function createBooking(p){
  const res=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'create',...p})});
  const txt=await res.text();let js;try{js=JSON.parse(txt);}catch{js=null;}
  if(js&&js.ok)return{ok:true};if(js&&js.code===409){const e=new Error(js.message||'conflict');e.code=409;throw e;}
  return{ok:false};
}

document.addEventListener('DOMContentLoaded',async()=>{
  applyTheme(localStorage.getItem('room_theme')||'dark');
  $('#btnDark').onclick=()=>applyTheme('dark');$('#btnLight').onclick=()=>applyTheme('light');
  $('#btnTH').onclick=()=>applyLang('th');$('#btnJP').onclick=()=>applyLang('ja');
  const tm=[];for(let h=0;h<24;h++)for(let m=0;m<60;m+=30)tm.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
  ['startSel','endSel'].forEach(id=>$( '#' + id).innerHTML=tm.map(t=>`<option>${t}</option>`).join(''));

  calendar=new FullCalendar.Calendar($('#calendar'),{
    initialView:'dayGridMonth',locale:currentLang,firstDay:0,height:'auto',
    headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,listMonth'},
    dateClick:i=>{
      openModal();
      const f=$('#bookingForm');f.date.value=i.dateStr;$('#startSel').value='10:00';$('#endSel').value='11:00';
      f.requester.focus();selectedDate=i.dateStr;renderDayList(selectedDate);
    },
    events:async(_info,success,failure)=>{
      try{latestRows=await fetchBookings();
        const filtered=currentFilter?latestRows.filter(r=>String(r.room).toUpperCase()===currentFilter):latestRows;
        success(buildEv(filtered));
        if(selectedDate)renderDayList(selectedDate);
      }catch(e){failure(e);}
    }
  });
  calendar.render();

  $('#btnCancel').onclick=()=>closeModal();
  $('#modalBackdrop').addEventListener('click',e=>{if(e.target.id==='modalBackdrop')closeModal();});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
  $('#filterRoom').addEventListener('change',e=>{currentFilter=e.target.value?e.target.value.toUpperCase():'';calendar.refetchEvents();});
  $('#btnPing').onclick=async()=>{const rows=await fetchBookings();alert('OK: '+rows.length+' bookings');};

  $('#bookingForm').onsubmit=async e=>{
    e.preventDefault();
    const fmsg=$('#formMsg');fmsg.className='msg';fmsg.textContent='';
    const data=Object.fromEntries(new FormData(e.target).entries());
    if(toMinutes(data.start)>=toMinutes(data.end)){fmsg.textContent=I18N[currentLang].errorEnd;fmsg.classList.add('err');return;}
    const btn=$('#btnSubmit');btn.disabled=true;btn.textContent='กำลังจอง...';
    try{
      await createBooking(data);
      fmsg.textContent=I18N[currentLang].success;fmsg.classList.add('ok');
      await calendar.refetchEvents();
      if(selectedDate===data.date)renderDayList(selectedDate);
      setTimeout(closeModal,500);
    }catch(err){
      fmsg.classList.add('err');fmsg.textContent=(err.code===409)?I18N[currentLang].conflictNow:(I18N[currentLang].error+err.message);
    }finally{btn.disabled=false;btn.textContent=I18N[currentLang].submit;}
  };

  applyLang('th');
  await calendar.refetchEvents();
});
</script>
</body>
</html>
