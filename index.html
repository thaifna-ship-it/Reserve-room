<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>จองห้องประชุม</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

  <style>
    :root {
      --bg:#0b1220;--panel:#0f172a;--border:#223047;--fg:#e5e7eb;--muted:#94a3b8;
      --primary:#22c55e;--danger:#ef4444;--dayred:#fee2e2;
      --input-bg:#0b1220;--btn-ghost-bg:#0b1220; --shadow:0 6px 20px rgba(0,0,0,.25);
    }
    [data-theme="light"] {
      --bg:#f6f7fb;--panel:#fff;--border:#e5e7eb;--fg:#0f172a;--muted:#64748b;
      --primary:#16a34a;--danger:#dc2626;--dayred:#fee2e2;--input-bg:#fff;--btn-ghost-bg:#f8fafc;
      --shadow:0 6px 20px rgba(0,0,0,.06);
    }

    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:6px 0 12px;font-size:1.6rem}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .right-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{border:1px solid var(--border);background:var(--btn-ghost-bg);color:var(--fg);padding:6px 10px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow);transition:.2s}
    .chip.active{background:linear-gradient(90deg,#16a34a,#22c55e);color:#062d13;border:0}
    .panel{background:linear-gradient(180deg,var(--panel),var(--bg));border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
    #calendar{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px}
    .fc .fc-daygrid-day.fc-day-today{background:rgba(34,197,94,.12)}
    .legend{font-size:.9rem;color:var(--muted);margin:10px 0 0}
    .legend i{display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--dayred);margin-right:6px;border:1px solid #fca5a5}

    .modal-backdrop{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:560px;max-width:calc(100vw - 24px);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid .full{grid-column:1/-1}
    label{display:block;font-size:.88rem;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;border-radius:10px;border:1px solid var(--border);background:var(--input-bg);color:var(--fg);padding:10px}
    [data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] button{color:#0f172a}
    .row{display:flex;gap:10px;margin-top:12px}
    .btn{cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);color:#062d13;border:0}
    .btn.ghost{background:var(--btn-ghost-bg)}
    .msg{margin-top:8px;font-size:.9rem}
    .msg.err{color:#ef4444}
    .msg.ok{color:#16a34a}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="toolbar">
        <h1 id="titleText">ปฏิทินจองห้อง</h1>
        <div class="right-tools">
          <!-- กรองห้อง (R1/R2) -->
          <select id="filterRoom" class="chip" style="padding:8px 12px">
            <option value="">ทุกห้อง</option>
            <option>R1</option>
            <option>R2</option>
          </select>

          <div class="lang-switch">
            <button type="button" id="btnTH" class="chip active">TH</button>
            <button type="button" id="btnJP" class="chip">JP</button>
          </div>
          <div class="theme-switch">
            <button type="button" id="btnDark" class="chip active">Dark</button>
            <button type="button" id="btnLight" class="chip">Light</button>
          </div>
          <button type="button" id="btnPing" class="chip">Test API</button>
        </div>
      </div>

      <div id="calendar"></div>
      <div class="legend"><i></i> <span id="legendText">มีการจองในวันนั้น</span></div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3 id="bookingTitle">จองห้อง</h3>
      <form id="bookingForm" autocomplete="off">
        <div class="grid">
          <div class="full">
            <label id="labelCompany">Company</label>
            <select name="company" required>
              <option value="" disabled selected id="optChooseCompany">เลือกบริษัท</option>
              <option>NCNA &amp; NC BIZ</option>
              <option>S.I.Placement</option>
              <option>Alberryasia</option>
            </select>
          </div>
          <div>
            <label id="labelRequester">Requester</label>
            <input name="requester" required>
          </div>
          <div>
            <label id="labelDate">วันที่</label>
            <input type="date" name="date" required>
          </div>
          <div>
            <label id="labelStart">Start time</label>
            <select name="start" id="startSel" required></select>
          </div>
          <div>
            <label id="labelEnd">End time</label>
            <select name="end" id="endSel" required></select>
          </div>
          <div class="full">
            <label id="labelRoom">Room</label>
            <select name="room" required>
              <option value="" disabled selected id="optChooseRoom">เลือกห้อง</option>
              <option>R1</option>
              <option>R2</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button type="button" class="btn ghost" id="btnCancel">ยกเลิก</button>
          <button type="submit" class="btn primary" id="btnSubmit">จอง</button>
        </div>
        <div class="msg" id="formMsg"></div>
      </form>
    </div>
  </div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwqYgWnnPY1bp4L637w1HCdPXpdEARkTvI20iYkirionUm-HfbDj-2cUKFySdJz8SMNjQ/exec";
const $ = (s,el=document)=>el.querySelector(s);
let currentLang='th';
let calendar, latestRows=[], currentFilter='';

const I18N={
  th:{title:'ปฏิทินจองห้อง',legend:'มีการจองในวันนั้น',modalTitle:'จองห้อง',
    company:'Company',chooseCompany:'เลือกบริษัท',requester:'Requester',date:'วันที่',
    start:'เวลาเริ่ม',end:'เวลาสิ้นสุด',room:'Room',chooseRoom:'เลือกห้อง',
    cancel:'ยกเลิก',submit:'จอง',errorEnd:'เวลาสิ้นสุดต้องมากกว่าเวลาเริ่มต้น',
    success:'จองสำเร็จ ✓',conflictNow:'ช่วงเวลานี้ถูกจองแล้ว',error:'ผิดพลาด: '},
  ja:{title:'会議室カレンダー',legend:'該当日に予約あり',modalTitle:'会議室を予約',
    company:'会社',chooseCompany:'会社を選択',requester:'申請者',date:'日付',
    start:'開始時刻',end:'終了時刻',room:'会議室',chooseRoom:'部屋を選択',
    cancel:'キャンセル',submit:'予約',errorEnd:'終了時刻は開始時刻より後にしてください',
    success:'予約完了 ✓',conflictNow:'予約済みの時間帯です',error:'エラー: '}
};

// ===== Theme =====
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme',theme);
  localStorage.setItem('room_theme',theme);
  $('#btnDark').classList.toggle('active',theme==='dark');
  $('#btnLight').classList.toggle('active',theme==='light');
}

// ===== Language (UI + Calendar) =====
function applyLang(l){
  currentLang=l;
  const t=I18N[l];
  $('#titleText').textContent=t.title;
  $('#legendText').textContent=t.legend;
  $('#bookingTitle').textContent=t.modalTitle;
  $('#labelCompany').textContent=t.company;
  $('#optChooseCompany').textContent=t.chooseCompany;
  $('#labelRequester').textContent=t.requester;
  $('#labelDate').textContent=t.date;
  $('#labelStart').textContent=t.start;
  $('#labelEnd').textContent=t.end;
  $('#labelRoom').textContent=t.room;
  $('#optChooseRoom').textContent=t.chooseRoom;
  $('#btnCancel').textContent=t.cancel;
  $('#btnSubmit').textContent=t.submit;
  $('#btnTH').classList.toggle('active',l==='th');
  $('#btnJP').classList.toggle('active',l==='ja');
  if(calendar){
    calendar.setOption('locale', l==='ja'?'ja':'th');
    calendar.updateSize();
  }
}

function openModal(){ $('#modalBackdrop').style.display='flex'; }
function closeModal(){ $('#modalBackdrop').style.display='none'; }

// === Fetch bookings (GET)
async function fetchBookings(){
  try{
    const r=await fetch(ENDPOINT+'?action=list&_='+Date.now());
    return r.ok?await r.json():[];
  }catch{return []}
}

// === Utilities
function toMinutes(t){const[a,b='0']=String(t).split(':');return (+a)*60 + (+b)}
function fmtTime(t){
  const [h,m]=t.split(':');
  return currentLang==='ja'
    ? h.padStart(2,'0')+':'+m.padStart(2,'0')
    : h.padStart(2,'0')+'.'+m.padStart(2,'0');
}
  function buildIdForClient(date, start, end, room){
  function pad2(n){return String(n).padStart(2,'0');}
  const [y,m,d] = date.split('-').map(Number);
  const [sh,sm='0'] = start.split(':').map(Number);
  const [eh,em='0'] = end.split(':').map(Number);
  const roomCanon = String(room).toUpperCase().includes('1') ? 'R1'
                  : String(room).toUpperCase().includes('2') ? 'R2'
                  : String(room).toUpperCase();
  return `${pad2(d)}-${pad2(m)}-${y}-${pad2(sh)}-${pad2(sm)}-${pad2(eh)}-${pad2(em)}-${roomCanon}`;
}

// === FullCalendar event builder
function buildEv(rows){
  const events = rows.map(x=>({
    id: x.BookingID || x.id || `${x.date}-${x.start}-${x.end}-${x.room}`,
    title: `${fmtTime(x.start)}-${fmtTime(x.end)} (${x.room})`,
    start: `${x.date}T${x.start}`,
    end:   `${x.date}T${x.end}`,
    color: '#ef4444'
  }));
  const days=[...new Set(rows.map(x=>x.date))];
  const bg=days.map(d=>({start:d,end:d,allDay:true,display:'background',backgroundColor:'#fee2e2'}));
  return events.concat(bg);
}

// === POST create booking
async function createBooking(payload){
  const wantId = buildIdForClient(payload.date, payload.start, payload.end, payload.room);

  // 1) พยายาม POST ไป Apps Script
  let serverJson = null;
  try{
    const res = await fetch(ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify({ action:'create', ...payload })
    });
    try{ serverJson = await res.json(); }catch{ serverJson = null; }
  }catch(_fetchErr){
    // เงียบไว้ แล้วไปยืนยันผลกับชีตแทน (หลีกเลี่ยงข้อความ Failed to fetch)
  }

  // 2) ตีความคำตอบจากเซิร์ฟเวอร์ถ้าได้
  if (serverJson){
    if (serverJson.ok) {
      return { ok:true, bookingId: serverJson.bookingId || wantId };
    }
    if (serverJson.code === 409){
      const e = new Error(serverJson.message || 'duplicate');
      e.code = 409;
      throw e; //ให้ onsubmit แสดงข้อความ "ช่วงเวลานี้ถูกจองแล้ว"
    }
    // อื่น ๆ ไม่ชัดเจน → ไปยืนยันกับชีต
  }

  // 3) ยืนยันผลกับชีต (กันกรณี CORS/parse ล้มเหลว)
  for (let i=0;i<4;i++){
    const rows = await fetchBookings();
    // สำเร็จ: พบ BookingID ที่ต้องการ
    if (rows.some(r => String(r.BookingID||'') === wantId)) {
      return { ok:true, bookingId: wantId };
    }
    // ชนซ้ำ: พบช่วงเวลาทับกันในห้องเดียวกัน วันเดียวกัน
    const s0 = toMinutes(payload.start), e0 = toMinutes(payload.end);
    const conflict = rows.find(r =>
      String(r.date)===payload.date &&
      String(r.room).toUpperCase()===String(payload.room).toUpperCase() &&
      !(e0 <= toMinutes(r.start) || s0 >= toMinutes(r.end))
    );
    if (conflict){
      const e = new Error('conflict');
      e.code = 409;
      throw e;
    }
    await new Promise(r=>setTimeout(r, 350));
  }

  // 4) ถ้าไม่พบอะไรเลยหลังรอ → แจ้งไม่สามารถยืนยัน
  const e = new Error('ไม่สามารถยืนยันการจองได้');
  e.code = 500;
  throw e;
}

document.addEventListener('DOMContentLoaded', async ()=>{
  // Theme init + buttons
  applyTheme(localStorage.getItem('room_theme')||'dark');
  $('#btnDark').onclick=()=>applyTheme('dark');
  $('#btnLight').onclick=()=>applyTheme('light');

  // Language buttons
  $('#btnTH').onclick=()=>applyLang('th');
  $('#btnJP').onclick=()=>applyLang('ja');

  // Time options
  const tm=[];
  for(let h=0;h<24;h++) for(let m=0;m<60;m+=30)
    tm.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
  ['startSel','endSel'].forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML=tm.map(t=>`<option>${t}</option>`).join('');
  });

  // Calendar
  calendar = new FullCalendar.Calendar($('#calendar'),{
    initialView:'dayGridMonth',
    locale: currentLang,
    firstDay:0,
    height:'auto',
    headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,listMonth'},
    dateClick:i=>{
      openModal();
      const f=$('#bookingForm');
      f.date.value=i.dateStr;
      $('#startSel').value='10:00';
      $('#endSel').value='11:00';
      f.requester.focus();
    },
    events: async (_info, success, failure) => {
      try{
        latestRows = await fetchBookings();
        const filtered = currentFilter ? latestRows.filter(r => String(r.room).toUpperCase()===currentFilter) : latestRows;
        success(buildEv(filtered));
      }catch(e){ failure(e); }
    }
  });
  calendar.render();

  // ปุ่มยกเลิก + ปิดเมื่อคลิกนอกกล่อง + ปิดด้วย Esc
  const cancelBtn = document.getElementById('btnCancel');
  const backdrop  = document.getElementById('modalBackdrop');
  cancelBtn.onclick = () => closeModal();
  backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  // ตัวกรองห้อง
  document.getElementById('filterRoom').addEventListener('change', e=>{
    currentFilter = e.target.value ? e.target.value.toUpperCase() : '';
    calendar.refetchEvents();
  });

  // ปุ่ม Test API
  document.getElementById('btnPing').onclick = async ()=>{
    const rows = await fetchBookings();
    alert('OK: '+rows.length+' bookings');
  };

  // ====== SUBMIT FORM (สำคัญ) ======
  document.getElementById('bookingForm').onsubmit = async (e)=>{
    e.preventDefault();
    const fmsg = document.getElementById('formMsg');
    fmsg.className='msg'; fmsg.textContent='';
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());

    // validate เบื้องต้น
    if (!data.start || !data.end || toMinutes(data.start) >= toMinutes(data.end)) {
      fmsg.textContent = I18N[currentLang].errorEnd; fmsg.classList.add('err'); return;
    }

    // ปุ่มกันกดซ้ำ
    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = true; btnSubmit.textContent = 'กำลังจอง...';

    try{
      await createBooking({
        requester: data.requester.trim(),
        company: data.company,
        date: data.date,     // yyyy-mm-dd
        start: data.start,   // HH:MM
        end:   data.end,     // HH:MM
        room:  data.room     // R1 / R2
      });
      fmsg.textContent = I18N[currentLang].success;
fmsg.classList.add('ok');
await calendar.refetchEvents();
setTimeout(closeModal, 500);
    } catch(err){
  const fmsg = document.getElementById('formMsg');
  fmsg.className = 'msg';

  if (err && err.code === 409) {
    // ซ้ำเวลา/ห้อง
    fmsg.textContent = I18N[currentLang].conflictNow;
    fmsg.classList.add('err');
  } else {
    // กรณีอื่น ๆ (เช่นยืนยันไม่สำเร็จจริง)
    fmsg.textContent = (I18N[currentLang].error || 'Error: ') + (err.message || '');
    fmsg.classList.add('err');
  }

  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = false;
  btnSubmit.textContent = I18N[currentLang].submit;
}
  };

  // ภาษาเริ่มต้น
  applyLang('th');
  await calendar.refetchEvents();
});
</script>
</body>
</html>
